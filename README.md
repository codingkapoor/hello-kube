# hello-kube project

The original hello project has been generated by the lagom/lagom-scala.g8 template. Kubernetes configuration has been added to show how a Lagom project can be deployed in a kubernetes cluster.

### Deployment

The steps to follow for deploying this project in kubernetes are:

- Start a kubernetes cluster. For test purposes you can use minikube
  ```
  $ minikube --vm-driver=virtualbox start
  ```
- Connect docker cli to minikube 
  ```
  $ eval $(minikube -p minikube docker-env)
  ```
- Create and publish the Docker container with the service. Since we have already connected docker cli to minikube in last step the newly published images will be made available directly within minikube docker instance reach 
  ```
  $ sbt docker:publishLocal
  ```
- Create the secrets with database and play secret
  ```
  $ kubectl create secret generic db-secret --from-literal=username=<user> --from-literal=password=<password>
  $ kubectl create secret generic hello-application-secret --from-literal=secret="$(openssl rand -base64 48)"
  ```
- Deploy rbac configuration role
  ```
  $ kubectl apply -f kubernetes/discovery-role.yaml
  ```
- Fetch IP of host machine addressable within the kubernetes cluster
  ```
  $ minikube ssh "route -n | grep ^0.0.0.0 | awk '{ print \$2 }'"
  ```
- Change the IP for Cassandra and Kafka services and deploy them
  ```
  $ kubectl apply -f kubernetes/cassandra-service.yaml
  $ kubectl apply -f kubernetes/kafka-service.yaml
  ```
  **Note:** Since producer kafka client is on the very same network as the brokers, we need to configure an additional listener like so:
  ```
  listeners=INTERNAL://0.0.0.0:9093,EXTERNAL://0.0.0.0:9092
  listener.security.protocol.map=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
  advertised.listeners=INTERNAL://localhost:9093,EXTERNAL://10.0.2.2:9092
  inter.broker.listener.name=INTERNAL
  ```
- Deploy the microservice.<br>
  ```
  $ kubectl apply -f kubernetes/hello-deployment.yaml
  ```
- Enable ingress addon and create ingress service
  ```
  $ minikube addons enable ingress
  $ kubectl apply -f kubernetes/ingress-service.yaml
  ```
- Fetch minikube cluster address and access APIs
  ```
  $ minikube ip
  $ curl -H "Content-Type: application/json" -X POST -d '{"message": "Hola"}' http://192.168.99.101/api/hello/Alice
  $ curl -X GET http://192.168.99.101/api/hello/Alice
  ```
- Verify the APIs 
  - Cass
  ```
  $ cqlsh> use hello
  $ cqlsh> select * from messages;
  ```

  - Kafka
  ```
  $ kafka-console-consumer.sh --bootstrap-server INTERNAL://0.0.0.0:9093 --topic greetings --from-beginning
  {"name":"Alice","message":"Namastey"}
  ```
